<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/base-layout :: layout(~{::title}, ~{::content})}">

<head>
    <title>Thanh toán - 2BShop</title>
</head>

<body>
    <div th:fragment="content">
        <style>
            /* Breadcrumb Styles */
            .breadcrumb-area {
                background: #f8f9fa;
                padding: 20px 0;
                border-bottom: 1px solid #e9ecef;
            }
            
            .breadcrumb-list {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .breadcrumb-list li {
                color: #6c757d;
            }
            
            .breadcrumb-list li a {
                color: #1a365d;
                text-decoration: none;
                transition: color 0.3s ease;
            }
            
            .breadcrumb-list li a:hover {
                color: #d4af37;
            }
            
            .breadcrumb-list li.active {
                color: #d4af37;
                font-weight: 600;
            }
            
            .breadcrumb-list li:not(:last-child)::after {
                content: "/";
                margin-left: 10px;
                color: #6c757d;
            }
            
            /* Checkout Page Styles */
            .checkout-area {
                padding: 60px 0;
                background: #f8f9fa;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }
            
            .row {
                display: flex;
                flex-wrap: wrap;
                margin: 0 -15px;
            }
            
            .col-lg-7 {
                flex: 0 0 58.333%;
                max-width: 58.333%;
                padding: 0 15px;
            }
            
            .col-lg-5 {
                flex: 0 0 41.667%;
                max-width: 41.667%;
                padding: 0 15px;
            }
            
            .col-lg-12 {
                flex: 0 0 100%;
                max-width: 100%;
                padding: 0 15px;
            }
            
            .col-lg-6 {
                flex: 0 0 50%;
                max-width: 50%;
                padding: 0 15px;
            }
            
            .col-12 {
                flex: 0 0 100%;
                max-width: 100%;
                padding: 0 15px;
            }
            
            .checkout-box, .order-summary-box {
                background: white;
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                margin-bottom: 30px;
            }
            
            .cart-page-title {
                font-size: 24px;
                font-weight: 700;
                color: #1a365d;
                margin-bottom: 30px;
                padding-bottom: 15px;
                border-bottom: 2px solid #d4af37;
            }
            
            .single-input-item {
                margin-bottom: 20px;
            }
            
            .single-input-item label {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                font-weight: 600;
                color: #1a365d;
            }
            
            .single-input-item label i {
                color: #d4af37;
                font-size: 16px;
            }
            
            .single-input-item .required {
                color: #dc3545;
            }
            
            .single-input-item input,
            .single-input-item textarea {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 15px;
                transition: all 0.3s ease;
            }
            
            .single-input-item input.error,
            .single-input-item textarea.error {
                border-color: #dc3545;
                background: #fff5f5;
            }
            
            .single-input-item .error-message {
                color: #dc3545;
                font-size: 13px;
                margin-top: 5px;
                display: none;
            }
            
            .single-input-item.has-error .error-message {
                display: block;
            }
            
            .single-input-item input:focus,
            .single-input-item textarea:focus {
                outline: none;
                border-color: #d4af37;
                box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
            }
            
            .single-input-item textarea {
                min-height: 100px;
                resize: vertical;
            }
            
            /* Order Summary Table */
            .your-order-table {
                margin-bottom: 25px;
            }
            
            .your-order-table table {
                width: 100%;
                border-collapse: collapse;
                table-layout: auto;
            }
            
            .your-order-table thead th {
                background: #f8f9fa;
                padding: 15px;
                font-weight: 700;
                color: #1a365d;
                border-bottom: 2px solid #d4af37;
                text-align: left;
            }
            
            .your-order-table thead th.product-name {
                width: 60%;
            }
            
            .your-order-table thead th.product-total {
                width: 40%;
                text-align: right;
            }
            
            .your-order-table tbody td {
                padding: 15px;
                border-bottom: 1px solid #e9ecef;
                vertical-align: top;
            }
            
            .your-order-table .product-name {
                font-weight: 600;
                color: #1a365d;
                word-break: break-word;
            }
            
            .your-order-table .product-quantity {
                color: #6c757d;
            }
            
            .your-order-table .product-total {
                text-align: right;
                font-weight: 700;
                color: #d4af37;
                white-space: nowrap;
                min-width: 120px;
            }
            
            .your-order-table .product-total .amount {
                display: inline-block;
            }
            
            .your-order-table tfoot th,
            .your-order-table tfoot td {
                padding: 12px 15px;
                border-top: 1px solid #e9ecef;
            }
            
            .your-order-table tfoot th {
                text-align: left;
                width: 60%;
            }
            
            .your-order-table tfoot td {
                text-align: right;
                white-space: nowrap;
                width: 40%;
            }
            
            .your-order-table tfoot .order-total th,
            .your-order-table tfoot .order-total td {
                font-size: 20px;
                font-weight: 700;
                color: #1a365d;
                background: #fffdf5;
                border-top: 2px solid #d4af37;
            }
            
            .your-order-table tfoot .order-total .amount {
                color: #d4af37;
            }
            
            /* Payment Method */
            .payment-method {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-top: 25px;
            }
            
            .payment-method h4 {
                font-size: 18px;
                font-weight: 700;
                color: #1a365d;
                margin-bottom: 20px;
            }
            
            .payment-method-item {
                background: white;
                padding: 15px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                margin-bottom: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .payment-method-item:hover {
                border-color: #d4af37;
                box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
            }
            
            .payment-method-item.active {
                border-color: #d4af37;
                background: #fffdf5;
            }
            
            .custom-control {
                position: relative;
                display: block;
                padding-left: 1.5rem;
            }
            
            .custom-control-input {
                position: absolute;
                left: 0;
                z-index: -1;
                opacity: 0;
            }
            
            .custom-control-label {
                position: relative;
                margin-bottom: 0;
                cursor: pointer;
                font-weight: 500;
                color: #1a365d;
            }
            
            .custom-control-label::before {
                position: absolute;
                top: 0.2rem;
                left: -1.5rem;
                display: block;
                width: 1rem;
                height: 1rem;
                pointer-events: none;
                content: "";
                background-color: #fff;
                border: 2px solid #adb5bd;
                border-radius: 50%;
            }
            
            .custom-control-label::after {
                position: absolute;
                top: 0.2rem;
                left: -1.5rem;
                display: block;
                width: 1rem;
                height: 1rem;
                content: "";
                background: no-repeat 50% / 50% 50%;
            }
            
            .custom-control-input:checked ~ .custom-control-label::before {
                background-color: #d4af37;
                border-color: #d4af37;
            }
            
            .custom-control-input:checked ~ .custom-control-label::after {
                background-image: radial-gradient(circle, #fff 35%, transparent 40%);
            }
            
            .custom-control-input:checked ~ .custom-control-label {
                color: #d4af37;
                font-weight: 600;
            }
            
            .custom-radio .custom-control-label::before {
                border-radius: 50%;
            }
            
            .custom-radio .custom-control-input:checked ~ .custom-control-label::after {
                background-image: radial-gradient(circle, #fff 35%, transparent 40%);
            }
            
            .payment-desc {
                margin-top: 8px;
                font-size: 13px;
                color: #6c757d;
                line-height: 1.5;
                padding-left: 25px;
            }
            
            /* Bank Selection Grid */
            .bank-selection-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
                margin: 15px 0;
            }
            
            .bank-option-card {
                background: white;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .bank-option-card:hover {
                border-color: #d4af37;
                box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
            }
            
            .bank-option-card.selected {
                border-color: #d4af37;
                background: #fffdf5;
            }
            
            .bank-logo-small {
                width: 50px;
                height: 50px;
                margin: 0 auto 10px;
                border-radius: 50%;
                background: #f8f9fa;
            }
            
            .bank-name-small {
                font-size: 13px;
                font-weight: 600;
                color: #1a365d;
            }
            
            .bank-detail-card {
                background: white;
                border: 2px solid #d4af37;
                border-radius: 8px;
                padding: 20px;
                margin-top: 15px;
                display: grid;
                grid-template-columns: 200px 1fr;
                gap: 20px;
            }
            
            .bank-qr-col {
                text-align: center;
            }
            
            .bank-text-col {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .qr-image-large {
                width: 100%;
                max-width: 200px;
                border-radius: 8px;
                border: 1px solid #e9ecef;
            }
            
            .fake-payment-box {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-top: 15px;
            }
            
            .fake-payment-box .input-group {
                display: flex;
                gap: 8px;
            }
            
            .fake-payment-box input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #ced4da;
                border-radius: 4px;
            }
            
            .fake-payment-box button {
                padding: 8px 16px;
                background: #d4af37;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                white-space: nowrap;
            }
            
            .fake-payment-box button:hover {
                background: #c9a961;
            }
            
            /* Utility Classes */
            .mt-2 { margin-top: 0.5rem; }
            .mt-4 { margin-top: 1.5rem; }
            .mb-4 { margin-bottom: 1.5rem; }
            .d-flex { display: flex; }
            .align-items-center { align-items: center; }
            .justify-content-center { justify-content: center; }
            .text-success { color: #28a745; }
            .table-responsive { overflow-x: auto; }
            
            .payment-note {
                margin-top: 8px;
                font-size: 13px;
                color: #6c757d;
                line-height: 1.5;
            }
            
            /* Place Order Button */
            .place-order button {
                width: 100%;
                padding: 16px;
                background: #d4af37;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 18px;
                font-weight: 700;
                text-transform: uppercase;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            }
            
            .place-order button:hover {
                background: #c9a961;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
            }
            
            .place-order button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .place-order button.loading {
                position: relative;
                color: transparent;
            }
            
            .place-order button.loading::after {
                content: '';
                position: absolute;
                width: 20px;
                height: 20px;
                top: 50%;
                left: 50%;
                margin-left: -10px;
                margin-top: -10px;
                border: 3px solid #fff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spinner 0.6s linear infinite;
            }
            
            @keyframes spinner {
                to { transform: rotate(360deg); }
            }
            
            /* Responsive */
            @media (max-width: 991px) {
                .col-lg-7, .col-lg-5, .col-lg-6, .col-lg-12 {
                    flex: 0 0 100%;
                    max-width: 100%;
                }
                
                .checkout-box, .order-summary-box {
                    padding: 20px;
                }
                
                .cart-page-title {
                    font-size: 20px;
                }
                
                .bank-detail-card {
                    grid-template-columns: 1fr;
                    text-align: center;
                }
                
                .qr-image-large {
                    max-width: 150px;
                }
            }
            
            @media (max-width: 576px) {
                .bank-selection-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        </style>
        
        <!-- Breadcrumb -->
        <div class="breadcrumb-area">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <ul class="breadcrumb-list">
                            <li><a href="/">Trang chủ</a></li>
                            <li><a href="/cart">Giỏ hàng</a></li>
                            <li class="active">Thanh toán</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checkout Area -->
        <div class="checkout-area section-padding">
            <div class="container">
                <form action="/checkout/place-order" method="post" id="checkoutForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="row">
                        <!-- Invoice Details -->
                        <div class="col-lg-7">
                            <div class="checkout-box">
                                <h3 class="cart-page-title">Thông tin giao hàng</h3>
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="single-input-item">
                                            <label><i class="fas fa-user"></i> Họ và tên người nhận <span class="required">*</span></label>
                                            <input type="text" name="receiverName" id="receiverName" required
                                                th:value="${user?.fullName}">
                                            <span class="error-message">Vui lòng nhập họ tên</span>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="single-input-item">
                                            <label><i class="fas fa-phone"></i> Số điện thoại <span class="required">*</span></label>
                                            <input type="text" name="phone" id="phone" required th:value="${user?.phone}">
                                            <span class="error-message">Vui lòng nhập số điện thoại hợp lệ</span>
                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <div class="single-input-item">
                                            <label><i class="fas fa-envelope"></i> Email <span class="required">*</span></label>
                                            <input type="email" name="email" id="email" required th:value="${user?.email}">
                                            <span class="error-message">Vui lòng nhập email hợp lệ</span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="single-input-item">
                                            <label><i class="fas fa-map-marker-alt"></i> Địa chỉ nhận hàng <span class="required">*</span></label>
                                            <input type="text" name="address" id="address" required th:value="${user?.address}"
                                                placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố">
                                            <span class="error-message">Vui lòng nhập địa chỉ nhận hàng</span>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="single-input-item">
                                            <label><i class="fas fa-sticky-note"></i> Ghi chú đơn hàng</label>
                                            <textarea name="notes" id="notes"
                                                placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="col-lg-5">
                            <div class="order-summary-box">
                                <h3 class="cart-page-title">Đơn hàng của bạn</h3>

                                <div class="your-order-table table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th class="product-name">Sản phẩm</th>
                                                <th class="product-total">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="cart_item" th:each="item : ${cartItems}">
                                                <td class="product-name">
                                                    <span th:text="${item.watch.watchName}">Product Name</span>
                                                    <strong class="product-quantity"> × <span
                                                            th:text="${item.quantity}">1</span></strong>
                                                    <br>
                                                    <small
                                                        th:text="${#numbers.formatDecimal(item.watch.getPriceAfterDiscount(), 0, 'COMMA', 0, 'POINT')} + ' ₫'">Price</small>
                                                </td>
                                                <td class="product-total">
                                                    <span class="amount"
                                                        th:text="${#numbers.formatDecimal(item.watch.getPriceAfterDiscount().multiply(item.quantity), 0, 'COMMA', 0, 'POINT')} + ' ₫'">Total</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="cart-subtotal">
                                                <th>Tạm tính</th>
                                                <td><span
                                                        th:text="${#numbers.formatDecimal(summary.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Subtotal</span>
                                                </td>
                                            </tr>
                                            <tr class="cart-subtotal" th:if="${summary.discountAmount > 0}">
                                                <th>Giảm giá</th>
                                                <td>-<span
                                                        th:text="${#numbers.formatDecimal(summary.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Discount</span>
                                                </td>
                                            </tr>
                                            <tr class="shipping">
                                                <th>Phí vận chuyển</th>
                                                <td>
                                                    <span th:if="${summary.shippingFee == 0}">Miễn phí</span>
                                                    <span th:if="${summary.shippingFee > 0}"
                                                        th:text="${#numbers.formatDecimal(summary.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Fee</span>
                                                </td>
                                            </tr>
                                            <tr class="order-total">
                                                <th>Tổng cộng</th>
                                                <td><strong><span class="amount"
                                                            th:text="${#numbers.formatDecimal(summary.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Total</span></strong>
                                                </td>
                                            </tr>

                                            <!-- Deposit Info -->
                                            <tr class="deposit-info" th:if="${summary.depositRequired}">
                                                <td colspan="2" style="background: #fffdf5; padding: 15px;">
                                                    <div style="color: #d4af37; font-weight: bold;">
                                                        <i class="fas fa-exclamation-circle"></i> ĐƠN HÀNG GIÁ TRỊ CAO
                                                    </div>
                                                    <div style="margin-top: 5px;">
                                                        Tiền cọc (25%): <strong style="color: #d4af37;"
                                                            th:text="${#numbers.formatDecimal(summary.depositAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Deposit</strong>
                                                    </div>
                                                    <div style="font-size: 13px; color: #666;">
                                                        Cần thanh toán còn lại: <span
                                                            th:text="${#numbers.formatDecimal(summary.totalAmount.subtract(summary.depositAmount), 0, 'COMMA', 0, 'POINT')} + ' ₫'">Remaining</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <div class="payment-method mt-4">
                                    <h4 style="font-size: 18px; margin-bottom: 20px;">Phương thức thanh toán</h4>

                                    <!-- COD -->
                                    <div class="payment-method-item" onclick="selectPayment('COD')">
                                        <div class="custom-control custom-radio">
                                            <input type="radio" id="payment_cod" name="paymentMethod" value="COD"
                                                class="custom-control-input" checked>
                                            <label class="custom-control-label" for="payment_cod">Thanh toán khi nhận
                                                hàng (COD)</label>
                                        </div>
                                        <div class="payment-desc mt-2" style="font-size: 13px; color: #666;">
                                            <span th:if="${summary.depositRequired}">
                                                Bạn cần cọc trước 25% giá trị đơn hàng. Phần còn lại sẽ thanh toán khi
                                                nhận hàng.
                                            </span>
                                            <span th:unless="${summary.depositRequired}">
                                                Thanh toán toàn bộ giá trị đơn hàng khi nhận hàng.
                                            </span>
                                        </div>
                                    </div>

                                    <!-- BANKING -->
                                    <div class="payment-method-item" onclick="selectPayment('BANKING')">
                                        <div class="custom-control custom-radio">
                                            <input type="radio" id="payment_banking" name="paymentMethod"
                                                value="BANKING" class="custom-control-input">
                                            <label class="custom-control-label" for="payment_banking">Chuyển khoản ngân
                                                hàng</label>
                                        </div>

                                        <div id="banking-details" class="bank-details" style="display:none;">
                                            <p style="font-size: 13px; margin-bottom: 10px;">Vui lòng chọn ngân hàng:
                                            </p>

                                            <!-- Bank Grid -->
                                            <div class="bank-selection-grid">
                                                <div th:each="bank : ${bankAccounts}" class="bank-option-card"
                                                    onclick="selectBank(this)" th:data-id="${bank.bankAccountId}"
                                                    th:data-name="${bank.bankName}"
                                                    th:data-number="${bank.accountNumber}"
                                                    th:data-owner="${bank.accountHolder}"
                                                    th:data-qr="${bank.getQrCodeUrl()}">

                                                    <!-- Logo Placeholder -->
                                                    <div class="bank-logo-small d-flex align-items-center justify-content-center"
                                                        style="font-size: 24px; color: #d4af37;">
                                                        <i class="fas fa-university"></i>
                                                    </div>

                                                    <div class="bank-name-small" th:text="${bank.bankName}">Bank Name
                                                    </div>
                                                    <input type="radio" name="bankAccountId"
                                                        th:value="${bank.bankAccountId}" required style="display:none">
                                                </div>
                                            </div>

                                            <!-- Details Panel -->
                                            <div id="selected-bank-info" style="display:none;">
                                                <div class="bank-detail-card">
                                                    <div class="bank-qr-col">
                                                        <img id="display-qr" src="" class="qr-image-large" alt="QR Code"
                                                            onerror="this.onerror=null;this.src='/images/default_product_placeholder.png'">
                                                    </div>
                                                    <div class="bank-text-col">
                                                        <h4 id="display-bank-name"
                                                            style="color: #333; margin-bottom: 5px; font-weight: bold;">
                                                            Bank Name</h4>
                                                        <p style="margin-bottom: 3px;">STK: <strong id="display-acc-num"
                                                                style="color: #d4af37; font-size: 18px;">Number</strong>
                                                        </p>
                                                        <p style="margin-bottom: 10px;">Chủ TK: <span id="display-owner"
                                                                style="font-weight: 500;">Holder</span></p>

                                                        <div class="fake-payment-box">
                                                            <p
                                                                style="font-size: 12px; margin-bottom: 5px; color: #666;">
                                                                <i class="fas fa-info-circle"></i> DEMO: Nhập mã giao
                                                                dịch
                                                            </p>
                                                            <div class="input-group">
                                                                <input type="text" name="transactionCodeInput"
                                                                    id="transactionCode"
                                                                    class="form-control form-control-sm"
                                                                    placeholder="Mã giao dịch..." required disabled>
                                                                <div class="input-group-append">
                                                                    <button type="button" class="btn btn-primary btn-sm"
                                                                        onclick="simulatePayment(this)">
                                                                        <i class="fas fa-magic"></i> Giả lập
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <small class="text-success mt-1" id="payment-status"
                                                                style="display:none; font-weight: bold;">
                                                                <i class="fas fa-check-circle"></i> Đã nhận mã: <span
                                                                    id="filled-code"></span>
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="place-order mt-4">
                                        <button type="submit" class="btn btn-primary btn-block btn-lg"
                                            style="width: 100%;">ĐẶT HÀNG</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Ensure jQuery is available
                if (typeof jQuery === 'undefined') {
                    console.error('jQuery is not loaded!');
                    return;
                }

                window.selectPayment = function (method) {
                    // Update radio buttons
                    if (method === 'COD') {
                        $('#payment_cod').prop('checked', true);
                        $('#banking-details').slideUp();
                        $('input[name="bankAccountId"]').prop('required', false);
                        $('#transactionCode').prop('disabled', true);
                    } else {
                        $('#payment_banking').prop('checked', true);
                        $('#banking-details').slideDown();
                        $('input[name="bankAccountId"]').prop('required', true);
                        // No default selection, user must click a bank
                    }

                    // Active class
                    $('.payment-method-item').removeClass('active');
                    $('input[value="' + method + '"]').closest('.payment-method-item').addClass('active');
                }

                function selectBank(element) {
                    // Highlight card
                    $('.bank-option-card').removeClass('active');
                    $(element).addClass('active');

                    // Check radio
                    $(element).find('input[type="radio"]').prop('checked', true);

                    // Get data
                    var id = $(element).data('id');
                    var name = $(element).data('name');
                    var number = $(element).data('number');
                    var owner = $(element).data('owner');
                    var qr = $(element).data('qr');

                    // Update display
                    $('#display-bank-name').text(name);
                    $('#display-acc-num').text(number);
                    $('#display-owner').text(owner);
                    if (qr && qr !== 'null') {
                        $('#display-qr').attr('src', qr);
                    } else {
                        $('#display-qr').attr('src', '/images/default_product_placeholder.png');
                    }

                    // Show details
                    $('#selected-bank-info').slideDown();

                    // Enable fake payment input
                    $('#transactionCode').prop('disabled', false);
                }

                function simulatePayment(btn) {
                    var randomCode = 'DEMO' + Math.floor(100000 + Math.random() * 900000);
                    console.log("FAKE PAYMENT CODE GENERATED: " + randomCode);

                    // Simulate typing/filling
                    $('#transactionCode').val(randomCode);

                    // Show status
                    $('#filled-code').text(randomCode);
                    $('#payment-status').fadeIn();

                    // Append code to notes if needed, handled by form submit if inputs share name? 
                    // We named it 'notes' but likely we want it separate. 
                    // Since this input is disabled when COD, it won't submit.
                    // When enabled, it submits as 'notes'. 
                    // BUT we already have a textarea named 'notes'. 
                    // This might create "note1, note2". 
                    // Let's rename it to 'transactionCode' and ignore it server side, 
                    // BUT append it to the real notes textarea before submit.
                }

                // Validate form on submit
                $('#checkoutForm').submit(function (e) {
                    e.preventDefault();
                    
                    // Clear previous errors
                    $('.single-input-item').removeClass('has-error');
                    $('input, textarea').removeClass('error');
                    
                    var isValid = true;
                    
                    // Validate required fields
                    var receiverName = $('#receiverName').val().trim();
                    if (!receiverName) {
                        $('#receiverName').closest('.single-input-item').addClass('has-error');
                        $('#receiverName').addClass('error');
                        isValid = false;
                    }
                    
                    var phone = $('#phone').val().trim();
                    if (!phone || !/^[0-9]{10,11}$/.test(phone)) {
                        $('#phone').closest('.single-input-item').addClass('has-error');
                        $('#phone').addClass('error');
                        isValid = false;
                    }
                    
                    var email = $('#email').val().trim();
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        $('#email').closest('.single-input-item').addClass('has-error');
                        $('#email').addClass('error');
                        isValid = false;
                    }
                    
                    var address = $('#address').val().trim();
                    if (!address) {
                        $('#address').closest('.single-input-item').addClass('has-error');
                        $('#address').addClass('error');
                        isValid = false;
                    }
                    
                    if (!isValid) {
                        alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                        return false;
                    }
                    
                    if ($('input[name="paymentMethod"]:checked').val() === 'BANKING') {
                        if ($('input[name="bankAccountId"]:checked').length === 0) {
                            alert('Vui lòng chọn ngân hàng chuyển khoản');
                            return false;
                        }

                        // Append transaction code to notes
                        var code = $('#transactionCode').val();
                        if (code) {
                            var currentNote = $('#notes').val();
                            var newNote = currentNote + (currentNote ? ". " : "") + "[Mã GD: " + code + "]";
                            $('#notes').val(newNote);
                        }
                    }
                    
                    // Show loading state
                    var submitBtn = $('.place-order button');
                    submitBtn.addClass('loading').prop('disabled', true);
                    
                    // Submit form
                    this.submit();
                });

                // Expose functions to window
                window.selectBank = selectBank;
                window.simulatePayment = simulatePayment;
            });
        </script>

        <!-- Order Success Modal -->
        <div id="orderSuccessModal" class="order-modal" style="display: none;">
            <div class="modal-content-custom">
                <div class="success-icon-box">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2 class="success-title">Đặt hàng thành công!</h2>
                
                <p class="success-message">Cảm ơn bạn đã tin tưởng mua sắm tại <strong>2BShop</strong></p>
                
                <div class="order-code-display" id="modalOrderCode">ORD000001</div>
                
                <div class="info-alert">
                    <i class="fas fa-envelope"></i>
                    <p>
                        <strong>Thông tin đơn hàng</strong> đã được gửi đến email: <strong id="modalCustomerEmail"></strong>
                        <br><br>
                        <i class="fas fa-headset"></i> Nhân viên sẽ liên hệ trong vòng <strong>24 giờ</strong> để xác nhận và giao hàng.
                        <br>
                        <i class="fas fa-phone-alt"></i> Hotline hỗ trợ: <strong style="color: #dc3545;">1900 8888</strong>
                    </p>
                </div>
                
                <div class="vat-download-box">
                    <h3><i class="fas fa-file-invoice"></i> Tải hóa đơn VAT</h3>
                    <p>Bạn có thể tải hóa đơn VAT ngay bây giờ hoặc từ email</p>
                    <div class="download-btns">
                        <a href="#" id="downloadWordBtn" class="btn-download btn-word">
                            <i class="fas fa-file-word"></i>
                            Tải Word (.docx)
                        </a>
                        <a href="#" id="downloadPdfBtn" class="btn-download btn-pdf">
                            <i class="fas fa-file-pdf"></i>
                            Tải PDF (.pdf)
                        </a>
                    </div>
                </div>
                
                <button class="btn-home-modal" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> Về trang chủ
                </button>
            </div>
        </div>

        <style>
            .order-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.75);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .modal-content-custom {
                background: #fff;
                border-radius: 12px;
                padding: 40px 35px;
                max-width: 550px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                text-align: center;
                animation: slideUp 0.4s ease;
            }
            
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            .success-icon-box {
                width: 90px;
                height: 90px;
                background: #28a745;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 25px;
            }
            
            .success-icon-box i {
                font-size: 45px;
                color: #fff;
            }
            
            .success-title {
                color: #1a365d;
                font-size: 28px;
                font-weight: 700;
                margin-bottom: 10px;
            }
            
            .success-message {
                font-size: 16px;
                color: #555;
                margin-bottom: 20px;
            }
            
            .order-code-display {
                display: inline-block;
                background: #d4af37;
                color: #fff;
                padding: 12px 28px;
                border-radius: 25px;
                font-size: 22px;
                font-weight: 700;
                letter-spacing: 1.5px;
                margin: 15px 0 25px;
            }
            
            .info-alert {
                background: #e3f2fd;
                border-left: 4px solid #2196F3;
                border-radius: 6px;
                padding: 18px;
                text-align: left;
                margin: 20px 0;
            }
            
            .info-alert i {
                color: #2196F3;
                margin-right: 8px;
            }
            
            .info-alert p {
                margin: 0;
                color: #0d47a1;
                line-height: 1.7;
                font-size: 14px;
            }
            
            .vat-download-box {
                background: #fff3cd;
                border: 2px dashed #d4af37;
                border-radius: 8px;
                padding: 20px;
                margin: 25px 0;
            }
            
            .vat-download-box h3 {
                color: #1a365d;
                margin-bottom: 10px;
                font-size: 18px;
            }
            
            .vat-download-box p {
                color: #666;
                font-size: 13px;
                margin-bottom: 15px;
            }
            
            .download-btns {
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .btn-download {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 12px 24px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 600;
                font-size: 14px;
                transition: all 0.3s ease;
                color: #fff;
            }
            
            .btn-word {
                background: #d4af37;
            }
            
            .btn-word:hover {
                background: #c19b2b;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
            }
            
            .btn-pdf {
                background: #dc3545;
            }
            
            .btn-pdf:hover {
                background: #c82333;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            }
            
            .btn-home-modal {
                background: #1a365d;
                color: #fff;
                border: none;
                padding: 14px 35px;
                border-radius: 6px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                margin-top: 25px;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            
            .btn-home-modal:hover {
                background: #0f1e35;
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(26, 54, 93, 0.4);
            }
            
            @media (max-width: 576px) {
                .modal-content-custom {
                    padding: 25px 20px;
                }
                .success-title { font-size: 22px; }
                .order-code-display { font-size: 18px; padding: 10px 20px; }
                .download-btns { flex-direction: column; }
                .btn-download { width: 100%; justify-content: center; }
            }
        </style>

        <script th:inline="javascript">
            /*<![CDATA[*/
            var orderSuccess = /*[[${orderSuccess}]]*/ false;
            var orderId = /*[[${orderId}]]*/ null;
            var orderCode = /*[[${orderCode}]]*/ '';
            var customerEmail = /*[[${customerEmail}]]*/ '';
            
            if (orderSuccess) {
                document.getElementById('modalOrderCode').textContent = orderCode;
                document.getElementById('modalCustomerEmail').textContent = customerEmail;
                document.getElementById('downloadWordBtn').href = '/invoice/' + orderId + '/word';
                document.getElementById('downloadPdfBtn').href = '/invoice/' + orderId + '/pdf';
                document.getElementById('orderSuccessModal').style.display = 'flex';
            }
            /*]]>*/
        </script>
    </div>
</body>

</html>