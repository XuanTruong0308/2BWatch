<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout/admin-layout :: layout(
        pageTitle='Quản Lý Người Dùng',
        activeMenu='users',
        content=~{::content},
        customStyles=~{},
        customScripts=~{::customScripts}
      )}">
<body>
    <div th:fragment="content">
        <!-- Filters & Search -->
        <div class="table-container mb-4">
            <div class="row align-items-center g-3">
                <div class="col-md-4">
                    <form method="get" class="input-group">
                        <input type="text" name="keyword" class="form-control" placeholder="Tìm theo tên, email..."
                               th:value="${keyword}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
                
                <div class="col-md-3">
                    <select class="form-select" onchange="window.location.href='/admin/users?isActive=' + this.value">
                        <option value="">Tất cả trạng thái</option>
                        <option value="true" th:selected="${selectedIsActive == true}">Active</option>
                        <option value="false" th:selected="${selectedIsActive == false}">Banned</option>
                    </select>
                </div>
                
                <div class="col-md-5 text-end">
                    <span class="badge bg-info fs-6 me-2">
                        Tổng: <span th:text="${users.totalElements}">0</span> users
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Users Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Họ Tên</th>
                            <th>Email</th>
                            <th>SĐT</th>
                            <th>Vai Trò</th>
                            <th class="text-center">Trạng Thái</th>
                            <th>Ngày Đăng Ký</th>
                            <th class="text-center">Thao Tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="user : ${users}">
                            <td><strong th:text="${user.userId}">1</strong></td>
                            <td>
                                <div>
                                    <strong th:text="${user.fullName}">Nguyen Van A</strong><br>
                                    <small class="text-muted" th:text="'@' + ${user.username}">@username</small>
                                </div>
                            </td>
                            <td th:text="${user.email}">user@example.com</td>
                            <td th:text="${user.phone}">0123456789</td>
                            <td>
                                <span th:each="userRole : ${user.userRoles}" 
                                      class="badge bg-secondary me-1" 
                                      th:text="${userRole.role.roleName}">
                                    USER
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge" 
                                      th:classappend="${user.isEnabled ? 'bg-success' : 'bg-danger'}"
                                      th:text="${user.isEnabled ? 'Active' : 'Banned'}">
                                    Active
                                </span>
                            </td>
                            <td th:text="${#temporals.format(user.createdDate, 'dd/MM/yyyy')}">
                                01/01/2026
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <a th:href="@{/admin/users/{id}(id=${user.userId})}" 
                                       class="btn btn-info" title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button th:if="${user.isEnabled}" 
                                            class="btn btn-warning" 
                                            onclick="showBanModal(this)" 
                                            th:data-user-id="${user.userId}"
                                            title="Ban user">
                                        <i class="fas fa-ban"></i>
                                    </button>
                                    <form th:if="${!user.isEnabled}"
                                          th:action="@{/admin/users/unban/{id}(id=${user.userId})}" 
                                          method="post" style="display: inline;">
                                        <button type="submit" class="btn btn-success" title="Unban">
                                            <i class="fas fa-check-circle"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        <!-- Fallback -->
                        <tr th:if="${users == null || users.content.isEmpty()}">
                            <td colspan="8" class="text-center">Chưa có user nào</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <nav th:if="${users.totalPages > 1}" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${users.first ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/admin/users(page=${users.number - 1}, keyword=${keyword}, isActive=${selectedIsActive})}">Trước</a>
                    </li>
                    
                    <li class="page-item" 
                        th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}"
                        th:classappend="${i == users.number ? 'active' : ''}">
                        <a class="page-link" th:href="@{/admin/users(page=${i}, keyword=${keyword}, isActive=${selectedIsActive})}" 
                           th:text="${i + 1}">1</a>
                    </li>
                    
                    <li class="page-item" th:classappend="${users.last ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/admin/users(page=${users.number + 1}, keyword=${keyword}, isActive=${selectedIsActive})}">Sau</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div th:fragment="customScripts">
        <!-- Modal HTML -->
        <div class="modal fade" id="banModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Ban User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="banForm">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Lý do ban <span class="text-danger">*</span></label>
                                <textarea name="reason" class="form-control" required rows="4" 
                                          placeholder="Nhập lý do ban user..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="submit" class="btn btn-danger">Xác Nhận Ban</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script th:inline="javascript">
            let currentUserId = null;
            const banModal = new bootstrap.Modal(document.getElementById('banModal'));
            
            function showBanModal(button) {
                currentUserId = button.getAttribute('data-user-id');
                document.getElementById('banForm').reset();
                banModal.show();
            }

            document.getElementById('banForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const reason = this.querySelector('[name="reason"]').value;
                const csrfToken = /*[[${_csrf.token}]]*/ '';
                const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
                
                fetch(`/admin/users/ban/${currentUserId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        [csrfHeader]: csrfToken
                    },
                    body: new URLSearchParams({ reason: reason })
                })
                .then(response => response.json())
                .then(data => {
                    banModal.hide();
                    
                    if (data.success) {
                        // Show success alert
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.table-container').insertAdjacentElement('beforebegin', alertDiv);
                        
                        // Update status badge in table
                        const userRow = document.querySelector(`button[data-user-id="${currentUserId}"]`).closest('tr');
                        const statusCell = userRow.querySelector('.text-center .badge');
                        statusCell.className = 'badge bg-danger';
                        statusCell.textContent = 'Banned';
                        
                        // Replace ban button with unban button
                        const actionCell = userRow.querySelector('.btn-group');
                        const banButton = actionCell.querySelector('.btn-warning');
                        banButton.outerHTML = `
                            <form action="/admin/users/unban/${currentUserId}" method="post" style="display: inline;">
                                <input type="hidden" name="${csrfHeader}" value="${csrfToken}" />
                                <button type="submit" class="btn btn-success" title="Unban">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            </form>
                        `;
                        
                        // Auto-dismiss alert after 3 seconds
                        setTimeout(() => alertDiv.remove(), 3000);
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    banModal.hide();
                    alert('Có lỗi xảy ra: ' + error);
                });
            });
        </script>
    </div>
</body>
</html>
