<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout/admin-layout :: layout(
        pageTitle='Thống Kê',
        activeMenu='dashboard',
        content=~{::content},
        customStyles=~{::styles},
        customScripts=~{::scripts}
      )}">
<head>
    <th:block th:fragment="styles">
        <style>
            .filter-card {
                background: white;
                border-radius: 12px;
                padding: 20px 28px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                margin-bottom: 30px;
            }
            
            .filter-card h5 {
                color: var(--navy);
                font-weight: 700;
                margin-bottom: 15px;
            }
            
            .filter-btn-group {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            
            .filter-btn {
                padding: 8px 20px;
                border: 2px solid var(--gold);
                background: white;
                color: var(--navy);
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .filter-btn:hover, .filter-btn.active {
                background: var(--gold);
                color: white;
            }
            
            .chart-container {
                position: relative;
                height: 380px;
            }
            
            .status-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .status-box {
                background: white;
                border-radius: 10px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.06);
                border-left: 4px solid;
            }
            
            .status-box.pending { border-left-color: #ffc107; }
            .status-box.confirmed { border-left-color: #17a2b8; }
            .status-box.shipping { border-left-color: #007bff; }
            .status-box.delivered { border-left-color: #28a745; }
            .status-box.cancelled { border-left-color: #dc3545; }
            
            .status-box h3 {
                font-size: 2rem;
                margin: 10px 0;
                font-weight: 700;
            }
            
            .status-box p {
                margin: 0;
                color: #6c757d;
                font-size: 0.9rem;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <!-- Period Filter -->
        <div class="filter-card">
            <h5><i class="fas fa-filter"></i> Lọc Thống Kê</h5>
            <form method="get" class="filter-btn-group">
                <button type="submit" name="period" value="week" 
                        class="filter-btn" th:classappend="${selectedPeriod == 'week' ? 'active' : ''}">
                    <i class="fas fa-calendar-week"></i> Tuần
                </button>
                <button type="submit" name="period" value="month" 
                        class="filter-btn" th:classappend="${selectedPeriod == 'month' ? 'active' : ''}">
                    <i class="fas fa-calendar-alt"></i> Tháng
                </button>
                <button type="submit" name="period" value="quarter" 
                        class="filter-btn" th:classappend="${selectedPeriod == 'quarter' ? 'active' : ''}">
                    <i class="fas fa-calendar"></i> Quý
                </button>
                <button type="submit" name="period" value="year" 
                        class="filter-btn" th:classappend="${selectedPeriod == 'year' ? 'active' : ''}">
                    <i class="fas fa-calendar-check"></i> Năm
                </button>
            </form>
        </div>
        
        <!-- Stats Cards Row -->
        <div class="row g-4 mb-4">
            <!-- Revenue Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card gold">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2"><strong>Lợi Nhuận</strong></p>
                            <h3 class="mb-0" style="color: var(--gold);" th:text="${#numbers.formatDecimal(revenue, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</h3>
                            <small class="text-success" th:if="${orderGrowth != null && orderGrowth > 0}">
                                <i class="fas fa-arrow-up"></i> 
                                <span th:text="${#numbers.formatDecimal(orderGrowth, 1, 2)}">0</span>%
                            </small>
                            <small class="text-danger" th:if="${orderGrowth != null && orderGrowth < 0}">
                                <i class="fas fa-arrow-down"></i> 
                                <span th:text="${#numbers.formatDecimal(orderGrowth, 1, 2)}">0</span>%
                            </small>
                        </div>
                        <div class="stat-icon gold">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Orders Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card navy">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2"><strong>Đơn Hàng</strong></p>
                            <h3 class="mb-0" style="color: var(--navy);" th:text="${orderCount}">0</h3>
                            <small class="text-muted">Tổng đơn hàng</small>
                        </div>
                        <div class="stat-icon navy">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Products Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2"><strong>Sản Phẩm</strong></p>
                            <h3 class="mb-0" style="color: #28a745;" th:text="${productCount}">0</h3>
                            <small class="text-muted">Đang hoạt động</small>
                        </div>
                        <div class="stat-icon success">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Users Card -->
            <div class="col-xl-3 col-md-6">
                <div class="stat-card info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-2"><strong>Người Dùng</strong></p>
                            <h3 class="mb-0" style="color: #17a2b8;" th:text="${userCount}">0</h3>
                            <small class="text-muted">Khách hàng</small>
                        </div>
                        <div class="stat-icon info">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Status Stats -->
        <div class="status-stats">
            <div class="status-box pending">
                <i class="fas fa-clock" style="font-size: 2rem; color: #ffc107;"></i>
                <h3 th:text="${orderStatsByStatus != null ? orderStatsByStatus['PENDING'] : 0}">0</h3>
                <p>Chờ xác nhận</p>
            </div>
            <div class="status-box confirmed">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: #17a2b8;"></i>
                <h3 th:text="${orderStatsByStatus != null ? orderStatsByStatus['CONFIRMED'] : 0}">0</h3>
                <p>Đã xác nhận</p>
            </div>
            <div class="status-box shipping">
                <i class="fas fa-shipping-fast" style="font-size: 2rem; color: #007bff;"></i>
                <h3 th:text="${orderStatsByStatus != null ? orderStatsByStatus['SHIPPING'] : 0}">0</h3>
                <p>Đang giao</p>
            </div>
            <div class="status-box delivered">
                <i class="fas fa-box-check" style="font-size: 2rem; color: #28a745;"></i>
                <h3 th:text="${orderStatsByStatus != null ? orderStatsByStatus['DELIVERED'] : 0}">0</h3>
                <p>Đã giao</p>
            </div>
            <div class="status-box cancelled">
                <i class="fas fa-times-circle" style="font-size: 2rem; color: #dc3545;"></i>
                <h3 th:text="${orderStatsByStatus != null ? orderStatsByStatus['CANCELLED'] : 0}">0</h3>
                <p>Đã hủy</p>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <!-- Revenue Chart -->
            <div class="col-xl-8">
                <div class="chart-card">
                    <h5><i class="fas fa-chart-bar"></i> Biểu Đồ Doanh Thu 12 Tháng</h5>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Brand Chart -->
            <div class="col-xl-4">
                <div class="chart-card">
                    <h5><i class="fas fa-chart-pie"></i> Sản Phẩm Theo Brand</h5>
                    <div class="chart-container">
                        <canvas id="brandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Orders Table -->
        <div class="table-container">
            <h5 class="mb-4" style="color: var(--navy); font-weight: 700; padding-bottom: 15px; border-bottom: 2px solid var(--gold);">
                <i class="fas fa-list"></i> Đơn Hàng Gần Đây
            </h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Mã ĐH</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${recentOrders}">
                            <td><strong style="color: var(--navy);" th:text="'#' + ${order.orderId}">ORD000001</strong></td>
                            <td th:text="${order.user.fullName}">Nguyễn Văn A</td>
                            <td th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">14/01/2026 10:30</td>
                            <td><strong th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">1,000,000₫</strong></td>
                            <td>
                                <span class="badge" 
                                      th:classappend="${order.orderStatus == 'PENDING' ? 'bg-warning' : 
                                                       order.orderStatus == 'CONFIRMED' ? 'bg-info' :
                                                       order.orderStatus == 'SHIPPING' ? 'bg-primary' :
                                                       order.orderStatus == 'DELIVERED' ? 'bg-success' : 'bg-danger'}"
                                      th:text="${order.orderStatus == 'PENDING' ? 'Chờ xác nhận' :
                                               order.orderStatus == 'CONFIRMED' ? 'Đã xác nhận' :
                                               order.orderStatus == 'SHIPPING' ? 'Đang giao' :
                                               order.orderStatus == 'DELIVERED' ? 'Đã giao' : 'Đã hủy'}">
                                    PENDING
                                </span>
                            </td>
                            <td>
                                <a th:href="@{/admin/orders/{id}(id=${order.orderId})}" class="btn btn-sm btn-gold">
                                    <i class="fas fa-eye"></i> Xem
                                </a>
                            </td>
                        </tr>
                        <tr th:if="${recentOrders == null || recentOrders.isEmpty()}">
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                                <p class="mb-0 mt-2">Chưa có đơn hàng nào</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <th:block th:fragment="scripts">
        <script th:inline="javascript">
            // Revenue Chart Data
            /*<![CDATA[*/
            const revenueData = /*[[${revenueChartData}]]*/ {labels: [], data: []};
            /*]]>*/
            const revenueCtx = document.getElementById('revenueChart');
            
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: revenueData.labels || [],
                        datasets: [{
                            label: 'Doanh Thu (₫)',
                            data: revenueData.data || [],
                            backgroundColor: 'rgba(212, 175, 55, 0.8)',
                            borderColor: '#d4af37',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'top',
                                labels: { font: { size: 13, weight: 'bold' } }
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('vi-VN').format(value) + '₫';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Brand Chart Data
            /*<![CDATA[*/
            const brandData = /*[[${brandChartData}]]*/ {labels: [], data: []};
            /*]]>*/
            const brandCtx = document.getElementById('brandChart');
            
            if (brandCtx) {
                new Chart(brandCtx, {
                    type: 'doughnut',
                    data: {
                        labels: brandData.labels || [],
                        datasets: [{
                            data: brandData.data || [],
                            backgroundColor: [
                                '#d4af37', '#1a365d', '#28a745', '#17a2b8',
                                '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true, 
                                position: 'bottom',
                                labels: { 
                                    font: { size: 12 },
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }
        </script>
        
        <script>
            // Auto-dismiss alerts after 5 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        </script>
    </th:block>
</body>
</html>
