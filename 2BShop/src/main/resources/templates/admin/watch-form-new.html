<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout/admin-layout :: layout(
        pageTitle='Quản Lý Sản Phẩm',
        activeMenu='watches',
        content=~{::content},
        customStyles=~{::styles},
        customScripts=~{::scripts}
      )}">
<head>
    <th:block th:fragment="styles">
        <style>
            .image-preview {
                max-width: 200px;
                max-height: 200px;
                border: 2px dashed #ddd;
                border-radius: 8px;
                padding: 10px;
                display: none;
                margin-top: 10px;
            }
            .image-preview img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 4px;
            }
        </style>
    </th:block>
</head>
<body>
    <div th:fragment="content">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header" style="border-left: 4px solid var(--gold);">
                        <h5 class="mb-0" th:text="${watch.watchId != null ? 'Chỉnh Sửa Sản Phẩм' : 'Thêm Sản Phẩм Mới'}">
                            Thêm Sản Phẩм Mới
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Product Form -->
                        <form th:action="@{/admin/watches/save}" method="post" enctype="multipart/form-data" th:object="${watch}">
                            <input type="hidden" th:field="*{watchId}" />
                            
                            <div class="row">
                                <!-- Left Column - Basic Info -->
                                <div class="col-md-8">
                                    <!-- Product Name -->
                                    <div class="mb-3">
                                        <label for="watchName" class="form-label">
                                            Tên sản phẩм <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="watchName" 
                                               th:field="*{watchName}" 
                                               required
                                               placeholder="Nhập tên sản phẩм">
                                    </div>
                                    
                                    <!-- Description -->
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Mô tả</label>
                                        <textarea class="form-control" 
                                                  id="description" 
                                                  th:field="*{description}" 
                                                  rows="4" 
                                                  placeholder="Nhập mô tả sản phẩм"></textarea>
                                    </div>
                                    
                                    <!-- Brand & Category -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="brandId" class="form-label">
                                                Thương hiệu <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" 
                                                    id="brandId" 
                                                    th:field="*{brand.brandId}" 
                                                    required>
                                                <option value="">-- Chọn thương hiệu --</option>
                                                <option th:each="brand : ${brands}" 
                                                        th:value="${brand.brandId}" 
                                                        th:text="${brand.brandName}">Brand</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="categoryId" class="form-label">
                                                Danh mục <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" 
                                                    id="categoryId" 
                                                    th:field="*{category.categoryId}" 
                                                    required>
                                                <option value="">-- Chọn danh mục --</option>
                                                <option th:each="category : ${categories}" 
                                                        th:value="${category.categoryId}" 
                                                        th:text="${category.categoryName}">Category</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Pricing & Inventory -->
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="price" class="form-label">
                                                Giá gốc (₫) <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="price" 
                                                   th:field="*{price}" 
                                                   placeholder="0">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="discountPercent" class="form-label">
                                                Giảm giá (%)
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="discountPercent" 
                                                   th:field="*{discountPercent}" 
                                                   placeholder="0">
                                            <small class="text-muted">0-100%</small>
                                            <div class="invalid-feedback"></div>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label for="stockQuantity" class="form-label">
                                                Tồn kho <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="stockQuantity" 
                                                   th:field="*{stockQuantity}" 
                                                   placeholder="0">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column - Images & Status -->
                                <div class="col-md-4">
                                    <!-- Main Image Upload -->
                                    <div class="mb-3">
                                        <label for="mainImage" class="form-label">Ảnh chính</label>
                                        <input type="file" 
                                               class="form-control" 
                                               id="mainImage" 
                                               name="mainImage" 
                                               accept="image/*"
                                               onchange="previewMainImage(this)">
                                        <small class="text-muted">JPG, PNG, WEBP</small>
                                        
                                        <!-- Main Image Preview -->
                                        <div class="image-preview" id="mainImagePreview">
                                            <img id="mainImageImg" src="" alt="Preview">
                                        </div>
                                        
                                        <!-- Existing Main Image -->
                                        <div th:if="${watch.watchId != null && watch.images != null && !watch.images.isEmpty()}" 
                                             class="mt-3">
                                            <small class="text-muted d-block mb-2">Ảnh hiện tại:</small>
                                            <img th:each="img : ${watch.images}" 
                                                 th:if="${img.isPrimary}"
                                                 th:src="${img.imageUrl}" 
                                                 class="img-thumbnail" 
                                                 style="max-width: 200px; max-height: 200px; object-fit: cover;">
                                        </div>
                                    </div>
                                    
                                    <!-- Gallery Images Upload -->
                                    <div class="mb-3">
                                        <label for="galleryImages" class="form-label">Ảnh phụ (nhiều ảnh)</label>
                                        <input type="file" 
                                               class="form-control" 
                                               id="galleryImages" 
                                               name="galleryImages" 
                                               accept="image/*"
                                               multiple>
                                        <small class="text-muted">Chọn nhiều ảnh</small>
                                        
                                        <!-- Existing Gallery Images -->
                                        <div th:if="${watch.watchId != null && watch.images != null && watch.images.size() > 1}" 
                                             class="mt-3">
                                            <small class="text-muted d-block mb-2">Ảnh phụ hiện tại:</small>
                                            <div class="row g-2">
                                                <div th:each="img : ${watch.images}" 
                                                     th:unless="${img.isPrimary}"
                                                     class="col-6">
                                                    <img th:src="${img.imageUrl}" 
                                                         class="img-thumbnail" 
                                                         style="width: 100%; height: 80px; object-fit: cover;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Active Status -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="isActive" 
                                                   th:field="*{isActive}">
                                            <label class="form-check-label" for="isActive">
                                                Kích hoạt sản phẩм
                                            </label>
                                        </div>
                                        <small class="text-muted">Tắt để ẩn khỏi trang chủ</small>
                                    </div>
                                    
                                    <!-- Sold Count (Read-only for edit) -->
                                    <div th:if="${watch.watchId != null}" class="mb-3">
                                        <label class="form-label">Đã bán</label>
                                        <input type="text" 
                                               class="form-control" 
                                               th:value="${watch.soldCount}" 
                                               readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form Actions -->
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <a th:href="@{/admin/watches}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Hủy
                                </a>
                                <button type="submit" class="btn" style="background-color: var(--gold); color: white;">
                                    <i class="fas fa-save me-2"></i>
                                    <span th:text="${watch.watchId != null ? 'Cập Nhật' : 'Tạo Mới'}">Lưu</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <script>
            // Preview main image
            function previewMainImage(input) {
                const preview = document.getElementById('mainImagePreview');
                const img = document.getElementById('mainImageImg');
                
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(input.files[0]);
                } else {
                    preview.style.display = 'none';
                }
            }

            // Form validation
            document.querySelector('form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                let isValid = true;
                
                // Clear previous errors
                document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                
                // Validate price
                const priceInput = document.getElementById('price');
                const priceValue = priceInput.value.trim();
                if (!priceValue) {
                    showError(priceInput, 'Vui lòng nhập giá gốc');
                    isValid = false;
                } else if (!/^\d+$/.test(priceValue)) {
                    showError(priceInput, 'Giá gốc phải là số nguyên dương');
                    isValid = false;
                } else if (priceValue.length > 15) {
                    showError(priceInput, 'Giá gốc không được vượt quá 15 chữ số');
                    isValid = false;
                } else if (parseInt(priceValue) <= 0) {
                    showError(priceInput, 'Giá gốc phải lớn hơn 0');
                    isValid = false;
                }
                
                // Validate discount percent
                const discountInput = document.getElementById('discountPercent');
                const discountValue = discountInput.value.trim();
                if (discountValue && !/^\d+$/.test(discountValue)) {
                    showError(discountInput, 'Giảm giá phải là số nguyên');
                    isValid = false;
                } else if (discountValue && (parseInt(discountValue) < 0 || parseInt(discountValue) > 100)) {
                    showError(discountInput, 'Giảm giá phải từ 0-100%');
                    isValid = false;
                }
                
                // Validate stock quantity
                const stockInput = document.getElementById('stockQuantity');
                const stockValue = stockInput.value.trim();
                if (!stockValue) {
                    showError(stockInput, 'Vui lòng nhập tồn kho');
                    isValid = false;
                } else if (!/^\d+$/.test(stockValue)) {
                    showError(stockInput, 'Tồn kho phải là số nguyên dương');
                    isValid = false;
                } else if (parseInt(stockValue) < 0) {
                    showError(stockInput, 'Tồn kho không được âm');
                    isValid = false;
                }
                
                if (isValid) {
                    this.submit();
                }
            });
            
            function showError(input, message) {
                input.classList.add('is-invalid');
                const feedback = input.nextElementSibling;
                if (feedback && feedback.classList.contains('invalid-feedback')) {
                    feedback.textContent = message;
                } else if (feedback && feedback.classList.contains('text-muted')) {
                    const errorDiv = feedback.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                        errorDiv.textContent = message;
                    }
                }
            }

            // Auto-dismiss alerts
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        </script>
    </th:block>
</body>
</html>
